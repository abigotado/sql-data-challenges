-- Определяем автомобиль с наименьшей средней позицией в гонках среди всех автомобилей

WITH
    CAR_AVERAGE_POSITION AS (
        -- Вычисляем среднюю позицию для каждого автомобиля, количество его гонок и страну производства
        SELECT
            C.NAME AS CAR_NAME, -- Название автомобиля
            C.CLASS AS CAR_CLASS, -- Класс автомобиля
            AVG(R.POSITION) AS AVERAGE_POSITION, -- Средняя позиция в гонках
            COUNT(R.RACE) AS RACE_COUNT, -- Количество гонок, в которых участвовал автомобиль
            CL.COUNTRY AS CAR_COUNTRY -- Страна производства класса автомобиля
        FROM
            CARS C
                JOIN RESULTS R ON C.NAME = R.CAR -- Соединяем автомобили с результатами гонок
                JOIN CLASSES CL ON C.CLASS = CL.CLASS -- Присоединяем информацию о классе автомобиля
        GROUP BY
            C.NAME,
            C.CLASS,
            CL.CLASS
    )

-- Выбираем автомобиль с наименьшей средней позицией
-- При равных значениях выбираем по алфавиту (по имени автомобиля)
SELECT
    CAR_NAME, -- Название автомобиля
    CAR_CLASS, -- Класс автомобиля
    AVERAGE_POSITION, -- Средняя позиция в гонках
    RACE_COUNT, -- Количество гонок
    CAR_COUNTRY -- Страна производства автомобиля
FROM
    CAR_AVERAGE_POSITION
ORDER BY
    AVERAGE_POSITION, -- Сортируем по наименьшей средней позиции
    CAR_NAME -- Если позиции одинаковы, выбираем автомобиль по алфавиту
LIMIT
    1; -- Оставляем только один автомобиль с наименьшей средней позицией