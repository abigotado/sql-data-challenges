-- Определяем классы автомобилей с наименьшей средней позицией в гонках

WITH
    -- Вычисляем среднюю позицию для каждого класса автомобилей и общее количество гонок, в которых участвовали автомобили этого класса
    CAR_AVERAGE_POSITION AS (
        SELECT
            C.CLASS AS CAR_CLASS, -- Класс автомобиля
            AVG(R.POSITION) AS AVERAGE_POSITION, -- Средняя позиция в гонках для всех автомобилей данного класса
            COUNT(R.RACE) AS TOTAL_RACES -- Общее количество гонок, в которых участвовали автомобили этого класса
        FROM
            CARS C
                JOIN RESULTS R ON C.NAME = R.CAR -- Присоединяем таблицу результатов гонок, связывая автомобиль с его выступлениями
        GROUP BY
            C.CLASS -- Группируем результаты по классу автомобиля
    ),

    -- Определяем классы автомобилей, у которых наименьшая средняя позиция в гонках
    MIN_CLASS AS (
        SELECT
            CAR_CLASS, -- Класс автомобиля
            AVERAGE_POSITION, -- Средняя позиция автомобилей данного класса
            TOTAL_RACES -- Общее количество гонок, в которых участвовали автомобили класса
        FROM
            CAR_AVERAGE_POSITION
        WHERE
            AVERAGE_POSITION = (
                -- Определяем минимальную среднюю позицию среди всех классов автомобилей
                SELECT
                    MIN(AVERAGE_POSITION) -- Находим минимальное среднее значение среди всех классов
                FROM
                    CAR_AVERAGE_POSITION
            )
    ),

    -- Получаем подробную информацию об автомобилях, которые принадлежат к классам с наименьшей средней позицией
    CAR_DETAILS AS (
        SELECT
            C.NAME AS CAR_NAME, -- Название автомобиля
            C.CLASS AS CAR_CLASS, -- Класс автомобиля
            AVG(R.POSITION) AS AVERAGE_POSITION, -- Средняя позиция данного автомобиля в гонках
            COUNT(R.RACE) AS RACE_COUNT, -- Количество гонок, в которых участвовал автомобиль
            CL.COUNTRY AS CAR_COUNTRY -- Страна производства автомобилей этого класса
        FROM
            CARS C
                JOIN RESULTS R ON C.NAME = R.CAR -- Присоединяем таблицу результатов гонок, связывая автомобили с их гонками
                JOIN CLASSES CL ON C.CLASS = CL.CLASS -- Присоединяем информацию о классе автомобиля, чтобы получить страну производства
        WHERE
            C.CLASS IN (
                -- Оставляем только те автомобили, которые принадлежат к классам с минимальной средней позицией
                SELECT
                    CAR_CLASS
                FROM
                    MIN_CLASS
            )
        GROUP BY
            C.NAME, -- Группируем по названию автомобиля
            C.CLASS, -- Класс автомобиля
            CL.COUNTRY -- Страна производства класса автомобиля
    )

-- Объединяем данные об автомобилях с информацией о классах и сортируем результаты
SELECT
    CD.CAR_NAME, -- Название автомобиля
    CD.CAR_CLASS, -- Класс автомобиля
    CD.AVERAGE_POSITION, -- Средняя позиция автомобиля в гонках
    CD.RACE_COUNT, -- Количество гонок, в которых участвовал автомобиль
    CD.CAR_COUNTRY, -- Страна производства класса автомобиля
    MC.TOTAL_RACES -- Общее количество гонок, в которых участвовали автомобили этого класса
FROM
    CAR_DETAILS CD
        JOIN MIN_CLASS MC ON CD.CAR_CLASS = MC.CAR_CLASS -- Соединяем автомобили с их классами, имеющими минимальную среднюю позицию
ORDER BY
    CD.AVERAGE_POSITION, -- Сортируем по средней позиции в гонках (от меньшей к большей)
    CD.CAR_NAME; -- Если средняя позиция одинакова, сортируем по названию автомобиля в алфавитном порядке